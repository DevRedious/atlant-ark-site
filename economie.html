<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Mon Solde - Atlant'ARK</title>
  <link rel="icon" type="image/x-icon" href="assets/images/logo_atlant_ark.ico">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Navigation horizontale -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="nav-brand">
        <img src="assets/images/logo_atlant_ark.ico" alt="Atlant'ARK">
        <span>Atlant'ARK</span>
      </a>
      
      <ul class="nav-menu">
        <li><a href="index.html" class="nav-link">Accueil</a></li>
        <li><a href="serveur.html" class="nav-link">Serveur</a></li>
        <li><a href="maps.html" class="nav-link">Cartes</a></li>
        <li><a href="mods.html" class="nav-link">Mods</a></li>
        <li><a href="discord.html" class="nav-link">Discord</a></li>
        <li><a href="economie.html" class="nav-link active">Mon Solde</a></li>
        <li><a href="support.html" class="nav-link">Support</a></li>
      </ul>

      <div class="nav-auth">
        <div class="stats-badge">
          <div class="online-dot"></div>
          <span id="quick-players">0</span> en ligne
        </div>
        
        <!-- Bouton de connexion -->
        <button class="discord-login-btn" id="login-btn" onclick="loginWithDiscord()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
          </svg>
          Se connecter
        </button>

        <!-- Profil utilisateur -->
        <div class="user-profile" id="user-profile">
          <div class="user-display" onclick="toggleUserMenu()">
            <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
            <div>
              <div class="user-name" id="user-name">Chargement...</div>
              <div class="user-balance" id="user-balance">
              <img src="assets/images/aqualis.png" class="currency-icon" alt="Aqualis">
              <span id="balance-value">0</span>
              </div>
            </div>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7 10l5 5 5-5z"/>
            </svg>
          </div>
          <div class="dropdown-menu" id="user-menu">
            <a href="#" class="dropdown-item" onclick="showProfile()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
              Mon Profil
            </a>
            <a href="#" class="dropdown-item logout" onclick="logout()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
              </svg>
              D√©connexion
            </a>
          </div>
        </div>

        <div class="mobile-menu">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Overlay -->
  <div class="mobile-overlay"></div>

  <!-- Contenu principal -->
  <main class="page-content">
    <div class="container">
      
      <!-- √âtat de chargement initial -->
      <div id="auth-loading" class="auth-required">
        <div class="loader" style="margin: 0 auto var(--spacing-md);"></div>
        <h3>V√©rification de l'authentification...</h3>
        <p>Chargement de votre solde</p>
      </div>

      <!-- Contenu principal (masqu√© jusqu'√† la connexion) -->
      <div id="economy-content" style="display: none;">
        
        <!-- En-t√™te -->
        <header class="page-header">
          <h1 class="page-title">Mon Solde Aqualis</h1>
          <p class="page-subtitle">Consultez votre solde en temps r√©el</p>
        </header>

        <!-- Carte principale du solde -->
        <div class="balance-showcase">
          <div class="balance-main-card">
            <div class="balance-amount-large" id="main-balance">0</div>
            <div class="balance-label-large">Aqualis disponibles</div>
            <button class="btn-secondary" onclick="refreshBalance()" style="margin-top: var(--spacing-lg); padding: var(--spacing-sm) var(--spacing-lg);">
              üîÑ Actualiser
            </button>
          </div>
        </div>

        <!-- Informations utilisateur -->
        <div class="stats-overview">
          <div class="stat-mini-card">
            <div class="stat-mini-value" id="user-pseudo">-</div>
            <div class="stat-mini-label">Pseudo ARK</div>
          </div>
          <div class="stat-mini-card">
            <div class="stat-mini-value" id="user-rank">-</div>
            <div class="stat-mini-label">Classement</div>
          </div>
          <div class="stat-mini-card">
            <div class="stat-mini-value" id="user-wins">-</div>
            <div class="stat-mini-label">Ench√®res gagn√©es</div>
          </div>
          <div class="stat-mini-card">
            <div class="stat-mini-value" id="last-update">-</div>
            <div class="stat-mini-label">Derni√®re MAJ</div>
          </div>
        </div>

        <!-- Historique des ench√®res -->
        <div class="card">
          <h3 style="color: var(--neon-green); margin-bottom: var(--spacing-md);">üìä Historique des Ench√®res</h3>
          <div id="auction-history-content">
            <p style="color: var(--text-muted); text-align: center;">Cliquez pour charger votre historique</p>
          </div>
          <button class="btn-secondary" onclick="loadAuctionHistory()" id="history-toggle-btn" style="margin-top: var(--spacing-md); width: 100%;">
            Afficher l'historique
          </button>
        </div>

        <!-- Informations et commandes Discord -->
        <div class="info-card">
          <h3>üí¨ Commandes Discord</h3>
          <p>G√©rez votre solde directement depuis Discord avec ces commandes :</p>
          <div style="display: grid; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
            <div style="background: var(--bg-secondary); padding: var(--spacing-sm); border-radius: var(--border-radius); font-family: 'Courier New', monospace;">
              <strong>/balance</strong> - Voir votre solde actuel
            </div>
            <div style="background: var(--bg-secondary); padding: var(--spacing-sm); border-radius: var(--border-radius); font-family: 'Courier New', monospace;">
              <strong>/register [pseudo]</strong> - Enregistrer votre pseudo ARK
            </div>
            <div style="background: var(--bg-secondary); padding: var(--spacing-sm); border-radius: var(--border-radius); font-family: 'Courier New', monospace;">
              <strong>/classement</strong> - Voir le classement des joueurs
            </div>
          </div>
          <p style="margin-top: var(--spacing-md);">
            <strong>Note :</strong> Pour modifier votre solde, contactez un administrateur sur Discord.
          </p>
        </div>
      </div>
    </div>
  </main>

  <!-- Scripts externes -->
  <script src="js/auth.js"></script>
  <script src="js/mobile-menu.js"></script>
  
  <!-- Script principal de la page √©conomie -->
  <script>
    // ===========================
    // CONFIGURATION
    // ===========================
    const API_URL = window.API_BASE_URL;
    // currentUser est d√©j√† d√©clar√© dans auth.js (variable globale)
    let historyLoaded = false;

    // ===========================
    // INITIALISATION
    // ===========================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üí∞ Initialisation de la page √©conomie');
      checkAuthenticationStatus();
    });

    // ===========================
    // GESTION DE L'AUTHENTIFICATION
    // ===========================
    async function checkAuthenticationStatus() {
      // üîÑ Attendre que auth.js soit charg√© et ait v√©rifi√© l'auth
      if (typeof window.AuthModule === 'undefined') {
        console.log('‚è≥ Attente du chargement d\'auth.js...');
        setTimeout(checkAuthenticationStatus, 100);
        return;
      }
      
      // Utiliser la fonction d'auth.js
      const isAuthenticated = window.AuthModule.isLoggedIn();
      const user = window.AuthModule.getCurrentUser();
      
      if (!isAuthenticated || !user) {
        redirectToLogin('Vous devez √™tre connect√© pour acc√©der √† cette page');
        return;
      }
      
      // Utilisateur connect√©
      currentUser = user;
      console.log('‚úÖ Utilisateur connect√©:', currentUser);
      await initializePage();
    }

    function redirectToLogin(message = '') {
      if (message) {
        sessionStorage.setItem('economy_redirect_message', message);
      }
      window.location.href = 'index.html';
    }

    async function initializePage() {
      showEconomyContent();
      await loadUserProfile();
      updateLastUpdateTime();
    }

    function showEconomyContent() {
      document.getElementById('auth-loading').style.display = 'none';
      document.getElementById('economy-content').style.display = 'block';
    }

    // ===========================
    // CHARGEMENT DES DONN√âES
    // ===========================
    async function loadUserProfile() {
      try {
        // Utiliser l'API moderne d'auth.js avec auto-refresh
        const userData = await window.AuthModule.apiCall('/user/profile');
        updateUserInterface(userData);
      } catch (error) {
        console.error('Erreur lors du chargement du profil:', error);
        if (error.message === 'Session expir√©e') {
          redirectToLogin('Votre session a expir√©, veuillez vous reconnecter');
        } else {
          showNotification('Impossible de charger les donn√©es du profil', 'error');
        }
      }
    }

    function updateUserInterface(userData) {
      // Mise √† jour du solde principal
      const formattedBalance = userData.balance ? userData.balance.toLocaleString('fr-FR') : '0';
      document.getElementById('main-balance').textContent = formattedBalance;
      
      // Mise √† jour des informations utilisateur
      document.getElementById('user-pseudo').textContent = userData.ark_name || 'Non d√©fini';
      document.getElementById('user-rank').textContent = userData.rank || 'Non class√©';
      document.getElementById('user-wins').textContent = userData.auction_wins || '0';
      
      updateLastUpdateTime();
    }

    function updateLastUpdateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('fr-FR', {
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('last-update').textContent = timeString;
    }

    // ===========================
    // ACTUALISATION MANUELLE
    // ===========================
    async function refreshBalance() {
      const button = event.target;
      const originalText = button.textContent;
      
      button.innerHTML = 'üîÑ Actualisation...';
      button.disabled = true;
      
      try {
        await loadUserProfile();
        showNotification('Solde actualis√© avec succ√®s', 'success');
      } catch (error) {
        showNotification('Erreur lors de l\'actualisation', 'error');
      } finally {
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 1000);
      }
    }

    // ===========================
    // HISTORIQUE DES ENCH√àRES
    // ===========================
    async function loadAuctionHistory() {
      const button = document.getElementById('history-toggle-btn');
      const content = document.getElementById('auction-history-content');
      
      if (historyLoaded) {
        // Masquer l'historique
        content.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Cliquez pour charger votre historique</p>';
        button.textContent = 'Afficher l\'historique';
        historyLoaded = false;
        return;
      }
      
      // Charger l'historique
      button.innerHTML = 'üîÑ Chargement...';
      button.disabled = true;
      
      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch(`${API_URL}/user/history`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const historyData = await response.json();
          displayAuctionHistory(historyData);
          button.textContent = 'Masquer l\'historique';
          historyLoaded = true;
        } else {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }
      } catch (error) {
        console.error('Erreur lors du chargement de l\'historique:', error);
        content.innerHTML = '<p style="color: var(--danger); text-align: center;">Erreur lors du chargement de l\'historique</p>';
        showNotification('Impossible de charger l\'historique', 'error');
      } finally {
        button.disabled = false;
      }
    }

    function displayAuctionHistory(historyData) {
      const content = document.getElementById('auction-history-content');
      
      if (!historyData || historyData.length === 0) {
        content.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Aucune ench√®re trouv√©e dans votre historique</p>';
        return;
      }
      
      const historyHTML = historyData.map(auction => {
        const date = new Date(auction.created_at).toLocaleDateString('fr-FR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const formattedPrice = auction.final_price.toLocaleString('fr-FR');
        const statusColor = auction.won ? 'var(--success)' : 'var(--text-muted)';
        const statusText = auction.won ? 'Remport√©' : 'Particip√©';
        const statusIcon = auction.won ? 'üèÜ' : 'üìà';
        
        return `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-md); border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: var(--spacing-sm); background: var(--bg-secondary);">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-xs);">
                ${statusIcon} ${auction.dino_name}
              </div>
              <div style="font-size: 0.9rem; color: var(--text-muted);">
                ${date}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 700; color: ${statusColor}; margin-bottom: var(--spacing-xs);">
                ${formattedPrice} Aqualis
              </div>
              <div style="font-size: 0.85rem; color: ${statusColor};">
                ${statusText}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      content.innerHTML = historyHTML;
    }

    // ===========================
    // NOTIFICATIONS
    // ===========================
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      const colors = {
        success: 'var(--success)',
        error: 'var(--danger)',
        info: 'var(--neon-blue)'
      };
      
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: var(--spacing-md);
        border-radius: var(--border-radius);
        z-index: 1000;
        max-width: 350px;
        font-weight: 600;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
      `;
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Animation d'entr√©e
      setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
      }, 100);
      
      // Animation de sortie et suppression
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    // ===========================
    // ACTUALISATION AUTOMATIQUE
    // ===========================
    setInterval(() => {
      if (currentUser && document.getElementById('economy-content').style.display !== 'none') {
        loadUserProfile();
      }
    }, 60000); // Actualisation toutes les minutes
  </script>

  <!-- üç™ Banner RGPD Cookies -->
  <div id="cookie-banner" class="cookie-banner" style="display: none;">
    <div class="cookie-content">
      <div class="cookie-icon">üç™</div>
      <div class="cookie-text">
        <h4>Utilisation des Cookies</h4>
        <p>Nous utilisons des cookies s√©curis√©s pour maintenir votre session et am√©liorer votre exp√©rience. Ces cookies sont essentiels au fonctionnement de nos services d'authentification Discord et de s√©curit√©.</p>
      </div>
      <div class="cookie-actions">
        <button id="accept-cookies" class="btn-primary btn-sm">
          ‚úÖ Accepter
        </button>
        <button id="learn-more-cookies" class="btn-secondary btn-sm">
          üìñ En savoir plus
        </button>
      </div>
    </div>
  </div>

  <script src="js/cookies.js"></script>
</body>
</html>
